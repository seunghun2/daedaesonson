# e-하늘 장사정보 시스템 크롤링 메뉴얼 (CRAWLING_METHOD.md)

이 문서는 `archive_crawler_batch.js` 스크립트를 사용하여 장사시설 정보를 크롤링하고 아카이빙하는 방법을 설명합니다.

## 1. 개요

이 스크립트는 e-하늘 장사정보 시스템 웹사이트를 방문하여 시설 리스트를 순회하며 다음 정보를 수집합니다:
- **가격표 (PDF)**: '가격' 탭의 내용을 PDF로 저장
- **사진**: '시설사진' 및 관련 탭의 이미지를 다운로드

## 2. 파일 구조 및 설정

- **스크립트 위치**: `scripts/archive_crawler_batch.js`
- **입력 데이터**: `data/raw_list.json` (크롤링 대상 리스트)
- **출력 디렉토리**: `archive/` (시설별 폴더 생성)

### `raw_list.json` 형식
크롤링 대상은 `scripts/prepare_batch.js`를 통해 준비합니다. 소스 JSON 파일(`esky_*.json`)에서 필요한 범위를 추출하여 `data/raw_list.json`에 저장합니다.

```json
[
  {
    "rno": 1,
    "companyname": "시설명",
    ...
  }
]
```

## 3. 실행 방법

### 1단계: 대상 리스트 준비
`scripts/prepare_batch.js` 파일을 열어 `SOURCE_FILE` (소스 JSON 경로)과 `START_RNO` (시작 번호)를 설정한 후 실행합니다.

```bash
node scripts/prepare_batch.js
```
이 명령은 `data/raw_list.json` 파일을 갱신합니다.

### 2단계: 크롤러 실행
다음 명령으로 크롤링을 시작합니다.

```bash
node scripts/archive_crawler_batch.js
```

## 4. 크롤링 로직 상세

1. **검색**: `companyname`을 사용하여 시설을 검색합니다.
2. **탭 탐색**: '장례식장', '묘지', '봉안시설', '자연장지' 탭을 순차적으로 확인하여 매칭되는 시설을 찾습니다.
3. **상세 페이지 이동**: 검색 결과에서 정확한 이름이 포함된 시설을 클릭합니다.
4. **데이터 수집**:
    - **가격 정보**: '가격' 탭을 클릭, 모든 아코디언 메뉴를 펼친 후 `page.pdf()`를 사용하여 전체 페이지를 저장합니다 (`price_info.pdf`).
    - **사진**: '시설사진', '갤러리' 등의 탭을 클릭, 이미지 URL을 수집하여 `photos/` 폴더에 다운로드합니다. 로고나 아이콘 등 작은 이미지는 필터링합니다.

## 5. 주의사항
- **정확성**: 시설명 검색 시 띄어쓰기나 괄호 포함 여부에 따라 검색 결과가 달라질 수 있으므로, 스크립트는 공백 제거 등의 보조 로직을 포함하고 있습니다.
- **네트워크**: 이미지 다운로드나 PDF 생성 시 네트워크 상태에 따라 지연이 발생할 수 있습니다.
- **배치 처리**: 대량의 데이터를 처리할 때는 중간에 멈출 경우를 대비해 `RNO`를 기준으로 분할하여 진행하는 것을 권장합니다.
