'use client';

import { useState, useMemo, useEffect, useRef } from 'react';
import { AppShell, Box, Flex, SegmentedControl, useMantineTheme, TextInput, Tabs, Group, Text } from '@mantine/core';
import { useMediaQuery } from '@mantine/hooks';
import { Map as MapIcon, List as ListIcon, Search, MapPin } from 'lucide-react';
import Link from 'next/link';
import Image from 'next/image';

import NaverMap, { NaverMapRef } from '@/components/map/NaverMap';
import FacilityList from '@/components/list/FacilityList';
import FilterBar from '@/components/list/FilterBar';
import FacilityDetail from '@/components/detail/FacilityDetail';
import { Facility, FACILITY_CATEGORY_LABELS } from '@/types';

export default function Home() {
  const theme = useMantineTheme();
  const isMobile = useMediaQuery(`(max-width: ${theme.breakpoints.sm})`);

  // ì§€ë„ ì»¨íŠ¸ë¡¤ Ref
  const mapRef = useRef<NaverMapRef>(null);

  // ìƒíƒœ ê´€ë¦¬
  const [activeCategory, setActiveCategory] = useState<string>('all');
  const [selectedFacility, setSelectedFacility] = useState<Facility | null>(null);
  const [mobileView, setMobileView] = useState<'map' | 'list'>('map');
  const [sortBy, setSortBy] = useState('rating');

  // ê²€ìƒ‰ì–´ ìƒíƒœ
  const [searchQuery, setSearchQuery] = useState('');
  const [submittedQuery, setSubmittedQuery] = useState(''); // ì—”í„° ì¹œ ê²€ìƒ‰ì–´
  const [searchFocused, setSearchFocused] = useState(false); // ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ì—¬ë¶€

  // DB ë°ì´í„° ìƒíƒœ
  const [dbFacilities, setDbFacilities] = useState<Facility[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // ì§€ë„ ë²”ìœ„ ë‚´ ì‹œì„¤ í•„í„°ë§ (ì´ˆê¸°ì—” ì „ì²´ ë‹¤ ë³´ì—¬ì¤Œ)
  const [visibleFacilities, setVisibleFacilities] = useState<Facility[]>([]);
  // í˜„ì¬ ì§€ë„ ì¢Œí‘œ
  const [currentBounds, setCurrentBounds] = useState<{ south: number, north: number, west: number, east: number } | null>(null);

  // 1. ì´ˆê¸° ë°ì´í„° ë¡œë“œ (API)
  useEffect(() => {
    async function fetchData() {
      try {
        const res = await fetch('/api/facilities', { cache: 'no-store', next: { revalidate: 0 } });
        if (res.ok) {
          const data = await res.json();
          setDbFacilities(data);
          setVisibleFacilities(data); // <-- ì´ˆê¸° ë°ì´í„° ì„¤ì • ë³µêµ¬
        }
      } catch (e) {
        console.error('Failed to fetch facilities', e);
      } finally {
        setIsLoading(false);
      }
    }
    fetchData();
  }, []);

  // 1-2. ë°ì´í„°ê°€ ë¡œë“œë˜ê±°ë‚˜ ì§€ë„ê°€ ì›€ì§ì˜€ì„ ë•Œ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  useEffect(() => {
    if (dbFacilities.length > 0 && currentBounds) {
      const inside = dbFacilities.filter(f =>
        f.coordinates &&
        f.coordinates.lat >= currentBounds.south &&
        f.coordinates.lat <= currentBounds.north &&
        f.coordinates.lng >= currentBounds.west &&
        f.coordinates.lng <= currentBounds.east
      );
      setVisibleFacilities(inside);
    }
  }, [dbFacilities, currentBounds]);

  // ê²€ìƒ‰(ì—”í„°) ì‹œ í•´ë‹¹ ì§€ì—­/ì‹œì„¤ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ ì´ë™
  useEffect(() => {
    if (!submittedQuery.trim() || !mapRef.current) return;

    const query = submittedQuery.trim().toLowerCase();
    // ì „ì²´ ë°ì´í„°ì—ì„œ ê²€ìƒ‰ ë§¤ì¹­ í™•ì¸
    const matches = dbFacilities.filter(f =>
      f.name.toLowerCase().includes(query) ||
      f.address.toLowerCase().includes(query)
    );

    if (matches.length > 0) {
      // ì¢Œí‘œê°€ ìˆëŠ” ì‹œì„¤ë“¤ì˜ í‰ê·  ìœ„ì¹˜ ê³„ì‚°
      const validCoords = matches
        .filter(f => f.coordinates)
        .map(f => f.coordinates!);

      if (validCoords.length > 0) {
        const avgLat = validCoords.reduce((sum, c) => sum + c.lat, 0) / validCoords.length;
        const avgLng = validCoords.reduce((sum, c) => sum + c.lng, 0) / validCoords.length;

        console.log(`ğŸ—ºï¸ ê²€ìƒ‰ ì´ë™: ${submittedQuery} -> ${avgLat}, ${avgLng}`);

        // ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ì— ë”°ë¼ ì¤Œ ë ˆë²¨ ì¡°ì • (ê²°ê³¼ê°€ ì ìœ¼ë©´ ë” í™•ëŒ€)
        const zoomLevel = matches.length === 1 ? 16 : 13;

        mapRef.current.panTo(avgLat, avgLng, zoomLevel);
        if (isMobile) setMobileView('map');
      }
    }
  }, [submittedQuery, dbFacilities, isMobile]);

  // ì§€ë„ ì´ë™ í•¸ë“¤ëŸ¬ (boundsë§Œ ì—…ë°ì´íŠ¸)
  const handleBoundsChanged = (bounds: { south: number, north: number, west: number, east: number }) => {
    setCurrentBounds(bounds);

    // ë²”ìœ„ ë‚´ í•„í„°ë§ (DB ì „ì²´ ë°ì´í„° ëŒ€ìƒ)
    // if (dbFacilities.length > 0) {
    //   const inside = dbFacilities.filter(f =>
    //     f.coordinates.lat >= bounds.south &&
    //     f.coordinates.lat <= bounds.north &&
    //     f.coordinates.lng >= bounds.west &&
    //     f.coordinates.lng <= bounds.east
    //   );
    //   setVisibleFacilities(inside);
    // }
  };

  // ìµœì¢… ë¦¬ìŠ¤íŠ¸ í•„í„°ë§ (ì§€ë„ ë²”ìœ„ AND ì¹´í…Œê³ ë¦¬ AND ê²€ìƒ‰ì–´ AND ì •ë ¬)
  const finalFacilities = useMemo(() => {
    // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ì „ì²´ ì‹œì„¤ì—ì„œ ê²€ìƒ‰, ì—†ìœ¼ë©´ í˜„ì¬ ë³´ì´ëŠ” ë²”ìœ„ ë‚´ì—ì„œ í•„í„°ë§
    let base = searchQuery.trim() ? dbFacilities : visibleFacilities;

    // 0. ì¥ë¡€ì‹ì¥ ê¸°ë³¸ ì œì™¸ (ì‚¬ìš©ì ìš”ì²­ì‚¬í•­)
    if (Array.isArray(base)) {
      base = base.filter(f => f.category !== 'FUNERAL_HOME');
    } else {
      base = [];
    }

    // 1. ì¹´í…Œê³ ë¦¬
    if (activeCategory !== 'all') {
      const catMap: Record<string, string> = {
        'charnel': 'CHARNEL_HOUSE',
        'natural': 'NATURAL_BURIAL',
        'park': 'FAMILY_GRAVE'
      };
      if (catMap[activeCategory]) {
        base = base.filter(f => f.category === catMap[activeCategory]);
      }
    }

    // 2. ê²€ìƒ‰ì–´ (ì´ë¦„ or ì£¼ì†Œ) - í•„í„°ë§ ì¬í™œì„±í™”
    if (searchQuery.trim()) {
      const query = searchQuery.trim().toLowerCase();
      base = base.filter(f =>
        f.name.toLowerCase().includes(query) ||
        f.address.toLowerCase().includes(query)
      );
    }

    // 3. ì •ë ¬
    return base.sort((a, b) => {
      if (sortBy === 'price') return a.priceRange.min - b.priceRange.min;
      if (sortBy === 'review') return (b.reviewCount || 0) - (a.reviewCount || 0);
      return Number(b.rating) - Number(a.rating);
    });
    // 4. ì§€ë„ ë²”ìœ„ ë‚´ í•„í„°ë§ ë¡œì§ì€ ìœ ì§€í•˜ë˜, ê²€ìƒ‰ìš© ë°ì´í„°ëŠ” ë³„ë„ë¡œ ê´€ë¦¬
  }, [visibleFacilities, activeCategory, sortBy, searchQuery, dbFacilities]);

  // ìë™ì™„ì„± ê²°ê³¼ ê³„ì‚°
  const autoCompleteResults = useMemo(() => {
    if (!searchQuery.trim() || dbFacilities.length === 0) return [];

    const query = searchQuery.trim().toLowerCase();

    // ì´ë¦„ ë§¤ì¹­ê³¼ ì£¼ì†Œ ë§¤ì¹­ì„ ì°¾ìŒ
    const matches = dbFacilities.filter(f =>
      f.name.toLowerCase().includes(query) ||
      f.address.toLowerCase().includes(query)
    );

    // ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ í‘œì‹œ
    return matches.slice(0, 10);
  }, [searchQuery, dbFacilities]);

  // ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ í•¸ë“¤ëŸ¬
  const handleSelectResult = (facility: Facility) => {
    setSearchQuery(facility.name); // ê²€ìƒ‰ì–´ ì°½ ì—…ë°ì´íŠ¸
    setSubmittedQuery(facility.name); // ê²€ìƒ‰ ì‹¤í–‰
    // íŒì—… ë‹«ê¸°ëŠ” Popoverì˜ opened ì œì–´ë¡œ ìë™ ì²˜ë¦¬ë¨ (searchQueryê°€ ë°”ë€Œë©´ ë‹¤ì‹œ ê³„ì‚°ë˜ì§€ë§Œ, ì„ íƒ í›„ ì—”í„° íš¨ê³¼)

    // ì¦‰ì‹œ ì´ë™
    if (mapRef.current && facility.coordinates) {
      console.log(`ğŸ” ì„ íƒ ì´ë™: ${facility.name}`);
      mapRef.current.panTo(facility.coordinates.lat, facility.coordinates.lng, 16);
      setSelectedFacility(facility);
      if (isMobile) setMobileView('map');
    }
  };

  const handleMarkerClick = (facility: Facility) => {
    setSelectedFacility(facility);
    if (isMobile) setMobileView('map');
  };

  // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŒ… ì»´í¬ë„ŒíŠ¸
  const HighlightText = ({ text, highlight }: { text: string, highlight: string }) => {
    if (!highlight.trim()) return <>{text}</>;
    // íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
    const escapedHighlight = highlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const parts = text.split(new RegExp(`(${escapedHighlight})`, 'gi'));
    return (
      <Text span size="sm">
        {parts.map((part, i) =>
          part.toLowerCase() === highlight.toLowerCase() ? (
            <Text span key={i} c="blue.6" fw={700}>{part}</Text>
          ) : (
            <Text span key={i}>{part}</Text>
          )
        )}
      </Text>
    );
  };

  return (
    <Flex h="100vh" direction={isMobile ? 'column' : 'row'} style={{ overflow: 'hidden' }}>
      {/* 1. ì¢Œì¸¡ íŒ¨ë„ */}
      <Flex
        direction="column"
        w={isMobile ? '100%' : 400}
        h="100%"
        bg="white"
        style={{
          borderRight: '1px solid #dee2e6',
          display: isMobile && mobileView === 'map' ? 'none' : 'flex',
          zIndex: 10,
          boxShadow: isMobile ? 'none' : '4px 0 12px rgba(0,0,0,0.05)'
        }}
      >
        {/* ì¢Œì¸¡ íŒ¨ë„ í—¤ë” - UI ìµœì í™” */}
        <Box p="sm" pl="md" pr="md" pb={4}>
          {/* ë¡œê³  + ê²€ìƒ‰ì°½ í•œ ì¤„ ë°°ì¹˜ */}
          <Group gap="sm" mb="sm" align="center" wrap="nowrap">
            {/* ë¡œê³  - ë¸Œëœë“œ ì»¬ëŸ¬ ì ìš© */}
            {/* ë¡œê³  - ë¸Œëœë“œ ì»¬ëŸ¬ ì ìš© */}
            <Link href="/" style={{ textDecoration: 'none', display: 'flex', alignItems: 'center', cursor: 'pointer', minWidth: 'fit-content' }}>
              <img
                src="/logo-horizontal.svg"
                alt="ëŒ€ëŒ€ì†ì†"
                width={105}
                height={30}
                style={{ objectFit: 'contain' }}
              />
            </Link>

            {/* ê²€ìƒ‰ì°½ + ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ (Flexë¡œ ë‚˜ë¨¸ì§€ ê³µê°„ ì±„ì›€) */}
            <Box pos="relative" style={{ flex: 1 }}>
              <TextInput
                placeholder="ì§€ì—­, ì‹œì„¤ëª… ê²€ìƒ‰"
                leftSection={<Search size={16} />}
                radius="md"
                size="md"
                value={searchQuery}
                onFocus={() => setSearchFocused(true)}
                onBlur={() => {
                  setTimeout(() => setSearchFocused(false), 200);
                }}
                onChange={(e) => setSearchQuery(e.currentTarget.value)}
                onKeyDown={(e) => {
                  if (e.key === 'Enter') {
                    setSubmittedQuery(searchQuery);
                    setSearchFocused(false);
                  }
                }}
                styles={{
                  input: {
                    backgroundColor: '#f8f9fa',
                    border: '1px solid #e9ecef',
                    fontSize: '15px'
                  }
                }}
              />

              {/* ìë™ì™„ì„± ëª©ë¡ */}
              {searchFocused && searchQuery.trim() && autoCompleteResults.length > 0 && (
                <Box
                  pos="absolute"
                  top="calc(100% + 8px)"
                  left={0}
                  w="100%"
                  bg="white"
                  style={{
                    zIndex: 2100, // ìƒì„¸ í˜ì´ì§€ í—¤ë”(1000)ë³´ë‹¤ ë†’ê²Œ ì„¤ì •í•˜ì—¬ ê°€ë¦¼ í˜„ìƒ í•´ê²°
                    borderRadius: 12,
                    boxShadow: '0 8px 30px rgba(0,0,0,0.12), 0 4px 10px rgba(0,0,0,0.05)',
                    border: '1px solid #f1f3f5',
                    overflow: 'hidden',
                    maxHeight: '400px',
                    overflowY: 'auto'
                  }}
                >
                  {autoCompleteResults.map((result, index) => (
                    <Box
                      key={result.id}
                      p="md"
                      style={{
                        cursor: 'pointer',
                        borderBottom: index === autoCompleteResults.length - 1 ? 'none' : '1px solid #f8f9fa',
                        transition: 'background-color 0.2s'
                      }}
                      className="hover:bg-gray-50"
                      onClick={() => handleSelectResult(result)}
                      onMouseDown={(e) => e.preventDefault()}
                    >
                      <Group justify="space-between" wrap="nowrap" align="flex-start">
                        <Box style={{ flex: 1, minWidth: 0 }}>
                          <Text size="sm" mb={2} style={{ lineHeight: 1.4 }}>
                            <HighlightText text={result.name} highlight={searchQuery} />
                          </Text>
                          <Text size="xs" c="dimmed" style={{ wordBreak: 'keep-all', lineHeight: 1.3 }}>
                            <HighlightText text={result.address} highlight={searchQuery} />
                          </Text>
                        </Box>
                        <Text
                          size="xs"
                          c="gray.5"
                          style={{
                            whiteSpace: 'nowrap',
                            backgroundColor: '#f8f9fa',
                            padding: '2px 6px',
                            borderRadius: 4
                          }}
                        >
                          {FACILITY_CATEGORY_LABELS[result.category]}
                        </Text>
                      </Group>
                    </Box>
                  ))}
                </Box>
              )}
            </Box>
          </Group>

          <Tabs
            value={activeCategory}
            onChange={(v) => setActiveCategory(v || 'all')}
            variant="pills"
            radius="xl"
            styles={{
              root: { marginTop: 8 },
              list: { gap: 6 }, // íƒ­ ê°„ê²©
              tab: {
                fontSize: '14px',
                fontWeight: 600,
                border: '1px solid transparent',
                height: '34px',
              }
            }}
          >
            <Tabs.List>
              {[
                { value: 'all', label: 'ì „ì²´' },
                { value: 'charnel', label: 'ë´‰ì•ˆë‹¹' },
                { value: 'natural', label: 'ìˆ˜ëª©ì¥' },
                { value: 'park', label: 'ê³µì›ë¬˜ì§€' }
              ].map(tab => {
                const isActive = activeCategory === tab.value;
                return (
                  <Tabs.Tab
                    key={tab.value}
                    value={tab.value}
                    style={{
                      backgroundColor: isActive ? '#3b4896' : 'transparent', // Custom Dark Blue for Active, Transparent for Inactive
                      color: isActive ? 'white' : '#495057', // White text for Active, Gray for Inactive
                      borderColor: isActive ? 'transparent' : 'transparent',
                      fontWeight: isActive ? 700 : 500
                    }}
                  >
                    {tab.label}
                  </Tabs.Tab>
                );
              })}
            </Tabs.List>
          </Tabs>
        </Box>

        {/* ìƒì„¸ ë³´ê¸° or ë¦¬ìŠ¤íŠ¸ */}
        <Box flex={1} h="100%" style={{ position: 'relative', overflowY: 'auto' }}>
          {selectedFacility && !isMobile ? (
            <FacilityDetail
              facility={selectedFacility}
              onClose={() => setSelectedFacility(null)}
            />
          ) : (
            <Flex direction="column" h="100%">
              <FilterBar sortBy={sortBy} setSortBy={setSortBy} totalCount={finalFacilities.length} />
              <FacilityList
                facilities={finalFacilities}
                onFacilityClick={handleMarkerClick}
                selectedId={selectedFacility?.id}
              />
            </Flex>
          )}
        </Box>
      </Flex>

      {/* 2. ìš°ì¸¡ ì§€ë„ (PC: ë‚˜ë¨¸ì§€ ê½‰ ì±„ì›€, ëª¨ë°”ì¼: 100%ì¸ë° ë·°ëª¨ë“œì— ë”°ë¼ ìˆ¨ê¹€) */}
      <Box
        flex={1}
        pos="relative"
        h="100%"
        style={{
          display: isMobile && mobileView === 'list' ? 'none' : 'block'
        }}
      >
        <NaverMap
          ref={mapRef}
          facilities={finalFacilities}
          onMarkerClick={handleMarkerClick}
          onBoundsChanged={handleBoundsChanged}
        />



      </Box>

      {/* ëª¨ë°”ì¼ ìƒì„¸ íŒì—… (Global Overlay) */}
      {isMobile && selectedFacility && (
        <Box
          pos="absolute" bottom={0} left={0} w="100%" h="85%" bg="white"
          style={{
            zIndex: 2000, // ë„¤ë¹„ê²Œì´ì…˜ë°” ë“±ë³´ë‹¤ ë†’ê²Œ
            borderTopLeftRadius: 20,
            borderTopRightRadius: 20,
            boxShadow: '0 -4px 20px rgba(0,0,0,0.15)',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden'
          }}
        >
          {/* ë“œë˜ê·¸ í•¸ë“¤ */}
          <Box w="100%" h={24} style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', flexShrink: 0 }}>
            <Box w={40} h={4} bg="gray.3" style={{ borderRadius: 2 }} />
          </Box>

          {/* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì»¨í…ì¸  ì˜ì—­ */}
          <Box style={{ flex: 1, overflowY: 'auto', paddingBottom: '20px' }}>
            <FacilityDetail
              facility={selectedFacility}
              onClose={() => setSelectedFacility(null)}
            />
          </Box>
        </Box>
      )}
      {/* Box removed */}

      {/* ëª¨ë°”ì¼ í•˜ë‹¨ ë·° í† ê¸€ ë²„íŠ¼ (Global Position) */}
      {
        isMobile && !selectedFacility && (
          <Box pos="absolute" bottom={30} left="50%" style={{ transform: 'translateX(-50%)', zIndex: 1000 }}>
            <SegmentedControl
              value={mobileView}
              onChange={(v) => setMobileView(v as 'map' | 'list')}
              data={[
                { label: <LabelCenter><MapIcon size={16} style={{ marginRight: 4 }} /> ì§€ë„</LabelCenter>, value: 'map' },
                { label: <LabelCenter><ListIcon size={16} style={{ marginRight: 4 }} /> ëª©ë¡</LabelCenter>, value: 'list' },
              ]}
              radius="xl"
              size="md"
              bg="white"
              styles={{ root: { boxShadow: '0 4px 12px rgba(0,0,0,0.15)' } }}
            />
          </Box>
        )
      }
    </Flex >
  );
}

function LabelCenter({ children }: { children: React.ReactNode }) {
  return <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>{children}</div>;
}
